workspace:
  base: /workdir
  path: .

pipeline:

  # Caching (restore if present)
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - ./maven-repo
      - ./nlp-data
      - ./ned-index
    volumes:
      - /tmp/cache:/cache
    when:
      event: [ push ]


  # Fetch data from S3 for testing (ned index)
  fetchModelData:
    image: meltwaterfoundation/drone-awscli
    pull: true
    secrets: [ aws_access_key_id, aws_secret_access_key ]
    environment:
      - AWS_REGION=eu-west-1
      - S3_NED_DATA_BUCKET=mw-fhai-nlp-models-eu-west-1
      - S3_NED_DATA_KEY=fhai-nlp-en-ned-data/5.4/index.zip
    commands:
      - echo 'Pull the ned index'
      - aws s3 sync s3://$S3_NED_DATA_BUCKET/$S3_NED_DATA_KEY index.zip
      - unzip /workdir/index.zip -d /workdir/ned-index
      - rm /workdir/index.zip
    when:
      event: [ push ]

  # Build and test.
  mavenBuild:
    image: meltwaterfoundation/drone-maven-jdk8
    pull: true
    secrets: [ artifactory_username, artifactory_password ]
    commands:
      - echo 'Build and test.'
      - mvn -B -U clean install -s settings.xml
    when:
      event: [ push ]

  # Deploy snapshot artifact to artifactory.
  mavenDeploySnapshot:
    image: meltwaterfoundation/drone-maven-jdk8
    pull: true
    secrets: [ artifactory_username, artifactory_password ]
    commands:
      - echo 'Deploy snapshot artifact to Artifactory.'
      - mvn -B -U clean deploy -s settings.xml
    when:
      event: [ push ]
      branch: [ master ]

  # Build test deploy release artifact to artifactory
  mavenDeployRelease:
    image: meltwaterfoundation/drone-maven-jdk8
    pull: true
    secrets: [ artifactory_username, artifactory_password, karma_robot_email, karma_robot_username, karma_github_token ]
    commands:
      - echo 'Release artifact'
      - mvn org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -s settings.xml -Dexpression=project.version -q -DforceStdout >> maven_artifact_version
      - export MAVEN_VERSION=$(eval cut -d- -f1 maven_artifact_version)
      - mvn -B versions:set -DremoveSnapshot -DnewVersion=$MAVEN_VERSION
      - rm maven_artifact_version
      - git config credential.helper 'cache --timeout=120'
      - git config user.email "$KARMA_ROBOT_EMAIL"
      - git config user.name "$KARMA_ROBOT_USERNAME"
      - git checkout release
      - git tag -a $MAVEN_VERSION release -m "Preparing release $MAVEN_VERSION"
      - git add pom.xml
      - git branch
      - git commit -m "Updating to release version $MAVEN_VERSION [CI SKIP]"
      - git push origin $MAVEN_VERSION
      - git push origin release
      - mvn -B -U clean deploy -s settings.xml
      - echo 'Setting development version to next increment.'
      - git fetch
      - git checkout --track origin/dev
      - mvn build-helper:parse-version versions:set -DnewVersion=\$${parsedVersion.majorVersion}.\$${parsedVersion.minorVersion}.\$${parsedVersion.nextIncrementalVersion}-\$${parsedVersion.qualifier}
      - mvn versions:commit
      - git add pom.xml
      - git commit -am "Incremented snapshot version."
      - git push origin dev
    when:
      event: [ push ]
      branch: [ release ]

  slack:
    group: notifications
    image: plugins/slack
    webhook: https://hooks.slack.com/services/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
    icon_url: https://logo.clearbit.com/drone.io
    username: 'Drone'
    channel: nlp-bots
    template: |
      {{#success build.status}}
        Build succeeded.
      {{else}}
        Build failed.
      {{/success}}
      Repo: `{{ repo.name }}`
      Branch: `{{ build.branch }}`
      Author: `{{ build.author }}`
      Commit: `{{ build.commit }}`
      Build: `{{ build.number }}`
    when:
      status: [ success, failure ]
      branch: [ master, release ]

  # Caching (create/refresh)
  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - ./maven-repo
      - ./nlp-data
      - ./ned-index
    volumes:
      - /tmp/cache:/cache
    when:
      event: [ push ]
